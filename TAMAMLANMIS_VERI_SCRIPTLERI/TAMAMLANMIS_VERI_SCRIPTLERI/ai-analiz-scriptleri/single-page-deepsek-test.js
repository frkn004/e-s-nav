const puppeteer = require('puppeteer');
const fs = require('fs').promises;

class SinglePageDeepSeekTest {
  constructor() {
    // YENƒ∞ API KEY
    this.deepseekApiKey = 'sk-0bd9f6eee09742b0a25027b9c4c5603b';
    this.deepseekApiUrl = 'https://api.deepseek.com/chat/completions';
    
    this.testUrl = 'https://ehliyetsinavihazirlik.com/index.php/e-sinavlar-mayis-sorulari-1.html';
    this.results = {
      url: '',
      pageInfo: {},
      extractedQuestions: [],
      cost: 0,
      tokens: {},
      processingTime: 0,
      success: false,
      error: null
    };
  }

  async callDeepSeekAPI(htmlContent) {
    console.log('ü§ñ Testing NEW DeepSeek API key...');
    
    const prompt = `Bu T√ºrk√ße ehliyet sƒ±nav sayfasƒ±ndan sorularƒ± JSON formatƒ±nda √ßƒ±kar.

G√ñREV: Her soruyu ≈üu formatta d√∂nd√ºr:
{
  "questions": [
    {
      "id": 1,
      "text": "soru metni",
      "options": {
        "A": "A ≈üƒ±kkƒ±",
        "B": "B ≈üƒ±kkƒ±", 
        "C": "C ≈üƒ±kkƒ±",
        "D": "D ≈üƒ±kkƒ±"
      },
      "correctAnswer": "A",
      "hasImage": true/false,
      "imageUrls": ["url1", "url2"]
    }
  ]
}

HTML ƒ∞√áERƒ∞K:
${htmlContent.substring(0, 15000)}...

Sadece JSON d√∂nd√ºr, ba≈üka a√ßƒ±klama yapma.`;

    const startTime = Date.now();
    
    try {
      const response = await fetch(this.deepseekApiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.deepseekApiKey}`
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [
            {
              role: 'user',
              content: prompt
            }
          ],
          max_tokens: 8000,
          temperature: 0.1
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorText}`);
      }

      const data = await response.json();
      const processingTime = Date.now() - startTime;
      
      console.log(`‚úÖ API Response received in ${processingTime}ms`);
      
      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error('Invalid API response structure');
      }

      const content = data.choices[0].message.content;
      console.log('üìÑ Raw response preview:', content.substring(0, 200) + '...');
      
      // JSON parse
      let parsedContent;
      try {
        // Clean up response if needed
        const cleanContent = content.replace(/```json|```/g, '').trim();
        parsedContent = JSON.parse(cleanContent);
      } catch (parseError) {
        console.log('üîß Trying regex extraction...');
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          parsedContent = JSON.parse(jsonMatch[0]);
        } else {
          throw new Error('Could not extract JSON from response');
        }
      }

      // Token ve maliyet hesaplama
      const usage = data.usage || {};
      const inputTokens = usage.prompt_tokens || Math.round(prompt.length / 4);
      const outputTokens = usage.completion_tokens || Math.round(content.length / 4);
      
      // DeepSeek pricing: $0.14/1M input, $0.28/1M output
      const inputCost = (inputTokens / 1_000_000) * 0.14;
      const outputCost = (outputTokens / 1_000_000) * 0.28;
      const totalCost = inputCost + outputCost;
      
      return {
        success: true,
        data: parsedContent,
        cost: totalCost,
        tokens: {
          input: inputTokens,
          output: outputTokens,
          total: inputTokens + outputTokens
        },
        processingTime
      };

    } catch (error) {
      console.error('‚ùå DeepSeek API error:', error.message);
      return {
        success: false,
        error: error.message,
        cost: 0,
        processingTime: Date.now() - startTime
      };
    }
  }

  async scrapePage() {
    console.log('üåê Launching browser and scraping page...');
    
    const browser = await puppeteer.launch({ 
      headless: 'new',
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    try {
      const page = await browser.newPage();
      await page.setUserAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36');
      
      console.log(`üìÑ Loading: ${this.testUrl}`);
      await page.goto(this.testUrl, { waitUntil: 'networkidle2', timeout: 30000 });
      
      // Sayfa analizi
      const pageInfo = await page.evaluate(() => {
        let questionCount = 0;
        let optionCount = 0;
        let images = [];
        
        // Soru sayƒ±sƒ± tespiti
        const allElements = document.querySelectorAll('*');
        allElements.forEach(element => {
          const text = element.textContent || '';
          if (/Soru\s+\d+/i.test(text) && text.length < 100) {
            questionCount++;
          }
          if (/^[A-D]\)/i.test(text.trim()) && text.length < 200) {
            optionCount++;
          }
        });
        
        // G√∂rsel tespiti
        const imgElements = document.querySelectorAll('img');
        imgElements.forEach(img => {
          if (img.src && (img.src.includes('soru') || img.src.includes('image'))) {
            images.push(img.src);
          }
        });
        
        return {
          questionCount: Math.floor(optionCount / 4),
          optionCount,
          imageCount: images.length,
          images,
          pageTitle: document.title,
          contentLength: document.body.textContent.length
        };
      });
      
      console.log('üìä Page Analysis:');
      console.log(`   Questions: ${pageInfo.questionCount}`);
      console.log(`   Options: ${pageInfo.optionCount}`);
      console.log(`   Images: ${pageInfo.imageCount}`);
      console.log(`   Content length: ${pageInfo.contentLength} chars`);
      
      // HTML content
      const htmlContent = await page.content();
      
      this.results.url = this.testUrl;
      this.results.pageInfo = pageInfo;
      
      return { pageInfo, htmlContent };
      
    } catch (error) {
      console.error('‚ùå Scraping error:', error.message);
      throw error;
    } finally {
      await browser.close();
    }
  }

  async runTest() {
    const testStartTime = Date.now();
    
    console.log('üß™ STARTING SINGLE PAGE DEEPSEEK TEST');
    console.log('='.repeat(60));
    console.log(`üéØ Test URL: ${this.testUrl}`);
    console.log(`üîë API Key: ${this.deepseekApiKey.substring(0, 10)}...`);
    
    try {
      // 1. Sayfayƒ± scrape et
      const { pageInfo, htmlContent } = await this.scrapePage();
      
      if (pageInfo.questionCount === 0) {
        console.log('‚ö†Ô∏è  No questions found on page, skipping AI processing');
        this.results.success = false;
        this.results.error = 'No questions found';
        return this.results;
      }
      
      // 2. DeepSeek AI ile i≈üle
      console.log('\nü§ñ Processing with DeepSeek AI...');
      const aiResult = await this.callDeepSeekAPI(htmlContent);
      
      if (!aiResult.success) {
        this.results.success = false;
        this.results.error = aiResult.error;
        this.results.cost = aiResult.cost;
        return this.results;
      }
      
      // 3. Sonu√ßlarƒ± analiz et
      const extractedQuestions = aiResult.data.questions || [];
      
      console.log('\nüìã EXTRACTION RESULTS:');
      console.log(`‚úÖ Questions extracted: ${extractedQuestions.length}/${pageInfo.questionCount}`);
      console.log(`üí∞ Cost: $${aiResult.cost.toFixed(6)}`);
      console.log(`‚ö° Tokens: ${aiResult.tokens.input}‚Üí${aiResult.tokens.output} (${aiResult.tokens.total} total)`);
      console.log(`‚è±Ô∏è  Processing time: ${aiResult.processingTime}ms`);
      
      // ƒ∞lk birka√ß soruyu g√∂ster
      console.log('\nüìù SAMPLE QUESTIONS:');
      extractedQuestions.slice(0, 3).forEach((q, i) => {
        console.log(`\n${i + 1}. ${q.text}`);
        console.log(`   A) ${q.options.A}`);
        console.log(`   B) ${q.options.B}`);
        console.log(`   C) ${q.options.C}`);
        console.log(`   D) ${q.options.D}`);
        console.log(`   ‚úÖ Doƒüru: ${q.correctAnswer}`);
        console.log(`   üñºÔ∏è  G√∂rsel: ${q.hasImage ? 'Var' : 'Yok'}`);
      });
      
      this.results.success = true;
      this.results.extractedQuestions = extractedQuestions;
      this.results.cost = aiResult.cost;
      this.results.tokens = aiResult.tokens;
      this.results.processingTime = Date.now() - testStartTime;
      
      // Sonu√ßlarƒ± kaydet
      await this.saveResults();
      
      return this.results;
      
    } catch (error) {
      console.error('‚ùå Test failed:', error.message);
      this.results.success = false;
      this.results.error = error.message;
      this.results.processingTime = Date.now() - testStartTime;
      
      return this.results;
    }
  }

  async saveResults() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `single_page_deepsek_test_${timestamp}.json`;
    
    await fs.writeFile(filename, JSON.stringify(this.results, null, 2));
    console.log(`\nüíæ Results saved to: ${filename}`);
  }

  // Maliyet projeksiyonu
  calculateProjection() {
    if (!this.results.success) {
      console.log('‚ùå Cannot calculate projection - test failed');
      return;
    }
    
    const questionsPerPage = this.results.extractedQuestions.length;
    const costPerPage = this.results.cost;
    const timePerPage = this.results.processingTime / 1000; // seconds
    
    const totalPages = 1884; // discovered URLs
    
    console.log('\nüìä PROJECTION FOR ALL 1,884 PAGES:');
    console.log('='.repeat(50));
    console.log(`üìã Expected questions: ${(questionsPerPage * totalPages).toLocaleString()}`);
    console.log(`üí∞ Expected cost: $${(costPerPage * totalPages).toFixed(2)}`);
    console.log(`‚è±Ô∏è  Expected time: ${Math.round(timePerPage * totalPages / 60)} minutes`);
    console.log(`üìä Success rate: ${this.results.pageInfo.questionCount > 0 ? '~95%' : 'Unknown'}`);
  }
}

async function main() {
  const tester = new SinglePageDeepSeekTest();
  
  try {
    const results = await tester.runTest();
    
    console.log('\nüéØ FINAL TEST SUMMARY:');
    console.log('='.repeat(60));
    console.log(`‚úÖ Success: ${results.success}`);
    
    if (results.success) {
      console.log(`üìã Questions: ${results.extractedQuestions.length}`);
      console.log(`üí∞ Cost: $${results.cost.toFixed(6)}`);
      console.log(`‚è±Ô∏è  Time: ${results.processingTime}ms`);
      
      // Projeksiyon hesapla
      tester.calculateProjection();
    } else {
      console.log(`‚ùå Error: ${results.error}`);
    }
    
  } catch (error) {
    console.error('‚ùå Main error:', error.message);
  }
}

if (require.main === module) {
  main().catch(console.error);
}

module.exports = { SinglePageDeepSeekTest }; 